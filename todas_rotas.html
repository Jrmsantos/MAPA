<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentação de Rede - Sistema de Redes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --info-color: #2980b9;
            --light-bg: #f8f9fa;
            --dark-text: #2c3e50;
            --gray-text: #7f8c8d;
            --border-color: #e1e8ed;
            --card-bg: #ffffff;
            --body-bg: #ecf0f1;
            --header-bg: #ffffff;
            --shadow-color: rgba(0,0,0,0.1);
            --shadow-light: 0 2px 10px rgba(0,0,0,0.08);
            --shadow-medium: 0 4px 15px rgba(0,0,0,0.1);
            --shadow-heavy: 0 8px 25px rgba(0,0,0,0.15);
        }

        [data-theme="dark"] {
            --primary-color: #ecf0f1;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --light-bg: #2c3e50;
            --dark-text: #ecf0f1;
            --gray-text: #bdc3c7;
            --border-color: #34495e;
            --card-bg: #34495e;
            --body-bg: #2c3e50;
            --header-bg: #34495e;
            --shadow-color: rgba(0,0,0,0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: var(--body-bg);
            min-height: 100vh;
            padding: 0;
            color: var(--dark-text);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        .header {
            background: var(--header-bg);
            padding: 1.5rem 2rem;
            border-radius: 15px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            color: var(--secondary-color);
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .theme-toggle {
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            transform: translateY(-2px);
        }
        
        .nav-btn {
            background: var(--secondary-color);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .nav-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        /* Filtros */
        .filters {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-group label {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.9rem;
        }
        
        .filter-select {
            padding: 0.7rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--dark-text);
            min-width: 200px;
        }
        
        .search-box {
            padding: 0.7rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--dark-text);
            min-width: 300px;
        }
        
        /* Layout Principal */
        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }
        
        /* Sidebar - Lista de Rotas */
        .routes-sidebar {
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: var(--shadow-medium);
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .sidebar-title {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .routes-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        
        .route-item {
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .route-item:hover {
            border-color: var(--secondary-color);
            transform: translateX(5px);
        }
        
        .route-item.active {
            border-color: var(--secondary-color);
            background: var(--light-bg);
        }
        
        .route-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        
        .route-item-name {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .route-item-badge {
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
        }
        
        .route-item-info {
            font-size: 0.8rem;
            color: var(--gray-text);
        }
        
        /* Conteúdo Principal */
        .documentation-content {
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: var(--shadow-medium);
            padding: 2rem;
            min-height: 600px;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .content-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .route-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .btn-primary { 
            background: var(--secondary-color); 
            color: white; 
        }
        .btn-success { 
            background: var(--success-color); 
            color: white; 
        }
        .btn-danger { 
            background: var(--accent-color); 
            color: white; 
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        /* Diagrama de Rede */
        .network-diagram {
            background: var(--light-bg);
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--border-color);
        }
        
        .diagram-placeholder {
            text-align: center;
            color: var(--gray-text);
        }
        
        .diagram-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--secondary-color);
        }
        
        /* Tabela de Conexões */
        .connections-section {
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .connections-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-light);
        }
        
        .connections-table th {
            background: var(--secondary-color);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }
        
        .connections-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .connections-table tr:hover {
            background: var(--light-bg);
        }
        
        .connection-status {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-active { background: var(--success-color); color: white; }
        .status-inactive { background: var(--gray-text); color: white; }
        .status-warning { background: var(--warning-color); color: white; }
        
        /* Lista de Equipamentos */
        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .equipment-card {
            background: var(--light-bg);
            border-radius: 10px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .equipment-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }
        
        .equipment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .equipment-name {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .equipment-type {
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
            background: var(--info-color);
        }
        
        .equipment-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .equipment-detail {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }
        
        .detail-label {
            color: var(--gray-text);
            font-weight: 500;
        }
        
        .detail-value {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .equipment-location {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.8rem;
            color: var(--gray-text);
        }
        
        /* Estado Vazio */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-text);
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            color: var(--border-color);
        }
        
        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--gray-text);
        }
        
        /* Modal para Gerenciar Equipamentos */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 15px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--secondary-color), var(--info-color));
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .close-modal {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .close-modal:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal-body {
            padding: 2rem;
        }

        /* Responsivo */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .routes-sidebar {
                position: static;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-select, .search-box {
                min-width: auto;
            }
            
            .equipment-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-network-wired"></i>
                Documentação de Rede
            </div>
            <div class="header-controls">
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
                <a href="index.html" class="nav-btn">
                    <i class="fas fa-map"></i> Ver Mapa
                </a>
            </div>
        </header>

        <div class="filters">
            <div class="filter-group">
                <label for="routeTypeFilter">Filtrar por Tipo:</label>
                <select class="filter-select" id="routeTypeFilter">
                    <option value="all">Todos os Tipos</option>
                    <option value="fibra">Fibra Óptica</option>
                    <option value="radio">Rádio Enlace</option>
                    <option value="metro">Metro Ethernet</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="statusFilter">Filtrar por Status:</label>
                <select class="filter-select" id="statusFilter">
                    <option value="all">Todos os Status</option>
                    <option value="active">Ativo</option>
                    <option value="inactive">Inativo</option>
                    <option value="warning">Com Problemas</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="searchBox">Buscar:</label>
                <input type="text" class="search-box" id="searchBox" placeholder="Buscar por rota, ponto ou equipamento...">
            </div>
        </div>

        <div class="main-content">
            <!-- Sidebar com Lista de Rotas -->
            <aside class="routes-sidebar">
                <h2 class="sidebar-title">
                    <i class="fas fa-list"></i>
                    Rotas Cadastradas
                </h2>
                <div class="routes-list" id="routesList">
                    <!-- Rotas serão carregadas aqui -->
                </div>
            </aside>

            <!-- Conteúdo Principal -->
            <main class="documentation-content">
                <div id="emptyState" class="empty-state">
                    <i class="fas fa-route"></i>
                    <h3>Nenhuma Rota Selecionada</h3>
                    <p>Selecione uma rota na lista ao lado para visualizar a documentação completa</p>
                </div>

                <div id="routeContent" style="display: none;">
                    <div class="content-header">
                        <h1 class="content-title">
                            <i class="fas fa-project-diagram"></i>
                            <span id="routeTitle">Nome da Rota</span>
                        </h1>
                        <div class="route-actions">
                            <button class="btn btn-primary" onclick="viewOnMap()">
                                <i class="fas fa-map-marker-alt"></i> Ver no Mapa
                            </button>
                            <button class="btn btn-success" onclick="openEquipmentManager()">
                                <i class="fas fa-edit"></i> Gerenciar Equipamentos
                            </button>
                        </div>
                    </div>

                    <!-- Informações da Rota -->
                    <div class="route-info-section" style="margin-bottom: 2rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: var(--light-bg); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.9rem; color: var(--gray-text); margin-bottom: 0.5rem;">Distância Total</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);" id="routeDistance">0 km</div>
                            </div>
                            <div style="background: var(--light-bg); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.9rem; color: var(--gray-text); margin-bottom: 0.5rem;">Pontos</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);" id="routePoints">0</div>
                            </div>
                            <div style="background: var(--light-bg); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.9rem; color: var(--gray-text); margin-bottom: 0.5rem;">Equipamentos</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);" id="routeEquipment">0</div>
                            </div>
                            <div style="background: var(--light-bg); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.9rem; color: var(--gray-text); margin-bottom: 0.5rem;">Status</div>
                                <div class="connection-status status-active" id="routeStatus">Ativo</div>
                            </div>
                        </div>
                        
                        <div style="background: var(--light-bg); padding: 1.5rem; border-radius: 8px;">
                            <h3 class="section-title"><i class="fas fa-info-circle"></i> Descrição da Rota</h3>
                            <p id="routeDescription" style="color: var(--gray-text); line-height: 1.6;">Sem descrição cadastrada.</p>
                        </div>
                    </div>

                    <!-- Tabela de Conexões -->
                    <div class="connections-section">
                        <h3 class="section-title"><i class="fas fa-link"></i> Conexões entre Pontos</h3>
                        <table class="connections-table">
                            <thead>
                                <tr>
                                    <th>Ponto de Origem</th>
                                    <th>Ponto de Destino</th>
                                    <th>Distância</th>
                                    <th>Tipo de Link</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="connectionsTable">
                                <!-- Conexões serão carregadas aqui -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Equipamentos por Ponto -->
                    <div class="equipment-section">
                        <h3 class="section-title"><i class="fas fa-server"></i> Equipamentos por Ponto</h3>
                        <div class="equipment-grid" id="equipmentGrid">
                            <!-- Equipamentos serão carregados aqui -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal para Gerenciar Equipamentos -->
    <div class="modal" id="equipmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-server"></i> Gerenciar Equipamentos: <span id="modalRouteName"></span></h3>
                <button class="close-modal" onclick="closeEquipmentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="equipmentManagerContent">
                    <!-- Conteúdo do gerenciador de equipamentos será carregado aqui -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentRoute = null;
        let allRoutes = [];
        let isDarkMode = false;

        // Carregar tema
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeToggle = document.getElementById('themeToggle');
            
            if (savedTheme === 'dark') {
                isDarkMode = true;
                document.documentElement.setAttribute('data-theme', 'dark');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                isDarkMode = false;
                document.documentElement.removeAttribute('data-theme');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }

        // Alternar tema
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            const themeToggle = document.getElementById('themeToggle');
            
            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                localStorage.setItem('theme', 'light');
            }
        }

        // Carregar rotas
        function loadRoutes() {
            allRoutes = JSON.parse(localStorage.getItem('ispRoutes')) || [];
            const routesList = document.getElementById('routesList');
            
            routesList.innerHTML = '';

            if (allRoutes.length === 0) {
                routesList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--gray-text);">
                        <i class="fas fa-route" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Nenhuma rota cadastrada</p>
                    </div>
                `;
                return;
            }

            allRoutes.forEach(route => {
                const badgeClass = `badge-${route.type}`;
                const badgeText = route.type === 'fibra' ? 'Fibra' : 
                                route.type === 'radio' ? 'Rádio' : 'Metro';
                const badgeColor = route.type === 'fibra' ? '#3498db' : 
                                 route.type === 'radio' ? '#9b59b6' : '#f39c12';

                const routeItem = document.createElement('div');
                routeItem.className = 'route-item';
                routeItem.setAttribute('data-route-id', route.id);
                routeItem.innerHTML = `
                    <div class="route-item-header">
                        <div class="route-item-name">${route.name}</div>
                        <div class="route-item-badge" style="background: ${badgeColor}">${badgeText}</div>
                    </div>
                    <div class="route-item-info">
                        ${route.points?.length || 0} pontos • ${route.distance} km
                    </div>
                `;
                
                routeItem.addEventListener('click', () => selectRoute(route.id));
                routesList.appendChild(routeItem);
            });

            // Selecionar primeira rota por padrão
            if (allRoutes.length > 0) {
                selectRoute(allRoutes[0].id);
            }
        }

        // Selecionar rota
        function selectRoute(routeId) {
            currentRoute = allRoutes.find(r => r.id == routeId);
            if (!currentRoute) return;

            // Atualizar itens ativos
            document.querySelectorAll('.route-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.route-item[data-route-id="${routeId}"]`).classList.add('active');

            // Mostrar conteúdo da rota
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('routeContent').style.display = 'block';

            // Atualizar informações da rota
            document.getElementById('routeTitle').textContent = currentRoute.name;
            document.getElementById('routeDistance').textContent = currentRoute.distance + ' km';
            document.getElementById('routePoints').textContent = currentRoute.points?.length || 0;
            
            // Contar equipamentos considerando redundância
            const equipmentCount = countTotalEquipment(currentRoute);
            document.getElementById('routeEquipment').textContent = equipmentCount;
            
            document.getElementById('routeDescription').textContent = currentRoute.description || 'Sem descrição cadastrada.';

            // Carregar conexões
            loadConnections();

            // Carregar equipamentos
            loadEquipment();
        }

        // Contar equipamentos totais (incluindo redundância)
        function countTotalEquipment(route) {
            if (!route.equipment) return 0;
            
            let count = route.equipment.length;
            
            // Contar pontos de redundância como equipamentos adicionais
            if (route.points) {
                route.points.forEach(point => {
                    if (point.redundantConnections && point.redundantConnections.length > 0) {
                        count += point.redundantConnections.length;
                    }
                });
            }
            
            return count;
        }

        // Carregar conexões entre pontos
        function loadConnections() {
            const connectionsTable = document.getElementById('connectionsTable');
            connectionsTable.innerHTML = '';

            if (!currentRoute.points || currentRoute.points.length < 2) {
                connectionsTable.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: var(--gray-text);">
                            <i class="fas fa-info-circle"></i> Esta rota precisa de pelo menos 2 pontos para mostrar conexões
                        </td>
                    </tr>
                `;
                return;
            }

            // Conexões principais entre pontos sequenciais
            for (let i = 0; i < currentRoute.points.length - 1; i++) {
                const pointA = currentRoute.points[i];
                const pointB = currentRoute.points[i + 1];
                
                const distance = calculateDistance(pointA.lat, pointA.lng, pointB.lat, pointB.lng);
                const linkType = getLinkType(currentRoute.type);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${pointA.name}</strong>
                        <div style="font-size: 0.8rem; color: var(--gray-text);">
                            ${pointA.lat.toFixed(4)}, ${pointA.lng.toFixed(4)}
                        </div>
                    </td>
                    <td>
                        <strong>${pointB.name}</strong>
                        <div style="font-size: 0.8rem; color: var(--gray-text);">
                            ${pointB.lat.toFixed(4)}, ${pointB.lng.toFixed(4)}
                        </div>
                    </td>
                    <td>${distance.toFixed(2)} km</td>
                    <td>${linkType}</td>
                    <td><span class="connection-status status-active">Ativo</span></td>
                `;
                connectionsTable.appendChild(row);
            }

            // Conexões de redundância
            if (currentRoute.points) {
                currentRoute.points.forEach(point => {
                    if (point.redundantConnections && point.redundantConnections.length > 0) {
                        point.redundantConnections.forEach(conn => {
                            if (conn.direction === 'outgoing') {
                                const targetPoint = currentRoute.points.find(p => p.id == conn.targetId);
                                if (targetPoint) {
                                    const distance = calculateDistance(point.lat, point.lng, targetPoint.lat, targetPoint.lng);
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>
                                            <strong>${point.name}</strong>
                                            <div style="font-size: 0.8rem; color: var(--gray-text);">
                                                ${point.lat.toFixed(4)}, ${point.lng.toFixed(4)}
                                            </div>
                                        </td>
                                        <td>
                                            <strong>${targetPoint.name}</strong>
                                            <div style="font-size: 0.8rem; color: var(--gray-text);">
                                                ${targetPoint.lat.toFixed(4)}, ${targetPoint.lng.toFixed(4)}
                                            </div>
                                            <div style="font-size: 0.7rem; color: #f39c12; margin-top: 0.2rem;">
                                                <i class="fas fa-sitemap"></i> Redundância
                                            </div>
                                        </td>
                                        <td>${distance.toFixed(2)} km</td>
                                        <td>${getRedundancyTypeDisplay(conn.type)}</td>
                                        <td><span class="connection-status status-active">Ativo</span></td>
                                    `;
                                    connectionsTable.appendChild(row);
                                }
                            }
                        });
                    }
                });
            }
        }

        // Carregar equipamentos
        function loadEquipment() {
            const equipmentGrid = document.getElementById('equipmentGrid');
            equipmentGrid.innerHTML = '';

            const hasEquipment = currentRoute.equipment && currentRoute.equipment.length > 0;
            const hasRedundancy = currentRoute.points && currentRoute.points.some(p => p.redundantConnections && p.redundantConnections.length > 0);

            if (!hasEquipment && !hasRedundancy) {
                equipmentGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--gray-text);">
                        <i class="fas fa-server" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Nenhum equipamento cadastrado nesta rota</p>
                        <button class="btn btn-success" onclick="openEquipmentManager()" style="margin-top: 1rem;">
                            <i class="fas fa-plus"></i> Adicionar Primeiro Equipamento
                        </button>
                    </div>
                `;
                return;
            }

            // Agrupar equipamentos por ponto
            const equipmentByPoint = {};
            if (currentRoute.equipment) {
                currentRoute.equipment.forEach(equip => {
                    if (!equipmentByPoint[equip.pointId]) {
                        equipmentByPoint[equip.pointId] = [];
                    }
                    equipmentByPoint[equip.pointId].push(equip);
                });
            }

            // Criar cards para cada ponto com equipamentos
            if (currentRoute.points) {
                currentRoute.points.forEach((point, index) => {
                    const pointEquipment = equipmentByPoint[point.id] || [];
                    const hasPointRedundancy = point.redundantConnections && point.redundantConnections.length > 0;

                    if (pointEquipment.length === 0 && !hasPointRedundancy) {
                        return; // Pular pontos sem equipamentos e sem redundância
                    }

                    const card = document.createElement('div');
                    card.className = 'equipment-card';
                    
                    let cardContent = `
                        <div class="equipment-header">
                            <div class="equipment-name">${point.name}</div>
                            <div class="equipment-type">
                                ${pointEquipment.length + (hasPointRedundancy ? point.redundantConnections.length : 0)} ${pointEquipment.length + (hasPointRedundancy ? point.redundantConnections.length : 0) === 1 ? 'item' : 'itens'}
                            </div>
                        </div>
                        <div class="equipment-location">
                            <i class="fas fa-map-marker-alt"></i> 
                            ${point.lat.toFixed(4)}, ${point.lng.toFixed(4)}
                            ${point.iconType && point.iconType !== 'default' ? ` • ${getIconDisplayName(point.iconType)}` : ''}
                        </div>
                    `;

                    // Adicionar equipamentos do ponto
                    if (pointEquipment.length > 0) {
                        cardContent += `<div style="margin-top: 1rem;">`;
                        pointEquipment.forEach(equip => {
                            cardContent += `
                                <div style="background: var(--card-bg); padding: 0.8rem; margin-bottom: 0.5rem; border-radius: 6px; border: 1px solid var(--border-color);">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                        <strong style="color: var(--primary-color);">${equip.name}</strong>
                                        <span style="font-size: 0.7rem; padding: 0.2rem 0.5rem; background: #3498db; color: white; border-radius: 10px;">
                                            ${getEquipmentTypeDisplay(equip.type)}
                                        </span>
                                    </div>
                                    ${equip.model ? `<div style="font-size: 0.8rem; color: var(--gray-text); margin-bottom: 0.3rem;">Modelo: ${equip.model}</div>` : ''}
                                    ${equip.config ? `<div style="font-size: 0.8rem; color: var(--gray-text);">Config: ${equip.config.substring(0, 50)}${equip.config.length > 50 ? '...' : ''}</div>` : ''}
                                </div>
                            `;
                        });
                        cardContent += `</div>`;
                    }

                    // Adicionar conexões de redundância
                    if (hasPointRedundancy) {
                        cardContent += `<div style="margin-top: 1rem;">`;
                        point.redundantConnections.forEach(conn => {
                            if (conn.direction === 'outgoing') {
                                const targetPoint = currentRoute.points.find(p => p.id == conn.targetId);
                                if (targetPoint) {
                                    cardContent += `
                                        <div style="background: #fff3cd; padding: 0.8rem; margin-bottom: 0.5rem; border-radius: 6px; border: 1px solid #ffeaa7;">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.3rem;">
                                                <strong style="color: #856404;">Conexão de Redundância</strong>
                                                <span style="font-size: 0.7rem; padding: 0.2rem 0.5rem; background: #f39c12; color: white; border-radius: 10px;">
                                                    ${getRedundancyTypeDisplay(conn.type)}
                                                </span>
                                            </div>
                                            <div style="font-size: 0.8rem; color: #856404;">
                                                <i class="fas fa-arrow-right"></i> Conectado a: ${targetPoint.name}
                                            </div>
                                            ${conn.description ? `<div style="font-size: 0.8rem; color: #856404; margin-top: 0.3rem;">${conn.description}</div>` : ''}
                                        </div>
                                    `;
                                }
                            }
                        });
                        cardContent += `</div>`;
                    }

                    card.innerHTML = cardContent;
                    equipmentGrid.appendChild(card);
                });
            }
        }

        // Abrir gerenciador de equipamentos
        function openEquipmentManager() {
            if (!currentRoute) return;
            
            document.getElementById('modalRouteName').textContent = currentRoute.name;
            loadEquipmentManager();
            document.getElementById('equipmentModal').style.display = 'flex';
        }

        // Fechar modal de equipamentos
        function closeEquipmentModal() {
            document.getElementById('equipmentModal').style.display = 'none';
        }

        // Carregar gerenciador de equipamentos
        function loadEquipmentManager() {
            const content = document.getElementById('equipmentManagerContent');
            content.innerHTML = '';

            if (!currentRoute.points || currentRoute.points.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--gray-text);">
                        <i class="fas fa-info-circle"></i>
                        <p>Esta rota não possui pontos cadastrados</p>
                    </div>
                `;
                return;
            }

            // Criar seção para cada ponto
            currentRoute.points.forEach((point, index) => {
                const pointSection = document.createElement('div');
                pointSection.style.marginBottom = '2rem';
                pointSection.style.padding = '1.5rem';
                pointSection.style.background = 'var(--light-bg)';
                pointSection.style.borderRadius = '8px';
                
                const pointEquipment = currentRoute.equipment?.filter(eq => eq.pointId == point.id) || [];
                
                pointSection.innerHTML = `
                    <h4 style="color: var(--primary-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-map-marker-alt"></i>
                        Ponto ${index + 1}: ${point.name}
                        ${point.iconType && point.iconType !== 'default' ? `<span style="font-size: 0.8rem; background: #3498db; color: white; padding: 0.2rem 0.5rem; border-radius: 10px; margin-left: auto;">${getIconDisplayName(point.iconType)}</span>` : ''}
                    </h4>
                    <div style="font-size: 0.8rem; color: var(--gray-text); margin-bottom: 1rem;">
                        ${point.lat.toFixed(4)}, ${point.lng.toFixed(4)}
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h5 style="color: var(--primary-color); margin-bottom: 1rem;">Adicionar Equipamento</h5>
                        <form onsubmit="addEquipment(event, ${point.id})" style="display: grid; gap: 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nome do Equipamento *</label>
                                    <input type="text" name="equipment_name" required style="width: 100%; padding: 0.7rem; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Tipo *</label>
                                    <select name="equipment_type" required style="width: 100%; padding: 0.7rem; border: 1px solid var(--border-color); border-radius: 6px;">
                                        <option value="">Selecione o tipo</option>
                                        <option value="olt">OLT</option>
                                        <option value="onu">ONU/Cliente</option>
                                        <option value="switch">Switch</option>
                                        <option value="router">Roteador</option>
                                        <option value="radio">Rádio</option>
                                        <option value="dwdm">DWDM</option>
                                        <option value="servidor">Servidor</option>
                                        <option value="cto">CTO/Caixa</option>
                                        <option value="director">Director Class</option>
                                        <option value="outro">Outro</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Modelo</label>
                                <input type="text" name="equipment_model" style="width: 100%; padding: 0.7rem; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Configuração</label>
                                <textarea name="equipment_config" style="width: 100%; padding: 0.7rem; border: 1px solid var(--border-color); border-radius: 6px; min-height: 80px;"></textarea>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Comentários</label>
                                <textarea name="equipment_comments" style="width: 100%; padding: 0.7rem; border: 1px solid var(--border-color); border-radius: 6px; min-height: 60px;"></textarea>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-plus"></i> Adicionar Equipamento
                            </button>
                        </form>
                    </div>
                    
                    <div>
                        <h5 style="color: var(--primary-color); margin-bottom: 1rem;">Equipamentos Cadastrados (${pointEquipment.length})</h5>
                        ${pointEquipment.length === 0 ? 
                            '<p style="color: var(--gray-text); text-align: center; padding: 1rem;">Nenhum equipamento cadastrado</p>' : 
                            pointEquipment.map(equip => `
                                <div style="background: var(--card-bg); padding: 1rem; margin-bottom: 0.8rem; border-radius: 6px; border: 1px solid var(--border-color);">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                        <strong>${equip.name}</strong>
                                        <div>
                                            <button onclick="editEquipment(${equip.id})" class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.8rem; margin-right: 0.5rem;">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteEquipment(${equip.id})" class="btn btn-danger" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div style="font-size: 0.8rem; color: var(--gray-text);">
                                        <div><strong>Tipo:</strong> ${getEquipmentTypeDisplay(equip.type)}</div>
                                        ${equip.model ? `<div><strong>Modelo:</strong> ${equip.model}</div>` : ''}
                                        ${equip.config ? `<div><strong>Configuração:</strong> ${equip.config}</div>` : ''}
                                        ${equip.comments ? `<div><strong>Comentários:</strong> ${equip.comments}</div>` : ''}
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                `;
                
                content.appendChild(pointSection);
            });
        }

        // Adicionar equipamento
        function addEquipment(event, pointId) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const newEquipment = {
                id: Date.now(),
                pointId: pointId,
                name: formData.get('equipment_name'),
                type: formData.get('equipment_type'),
                model: formData.get('equipment_model'),
                config: formData.get('equipment_config'),
                comments: formData.get('equipment_comments'),
                createdAt: new Date().toISOString()
            };

            // Atualizar a rota
            const routes = JSON.parse(localStorage.getItem('ispRoutes')) || [];
            const routeIndex = routes.findIndex(r => r.id == currentRoute.id);
            
            if (routeIndex !== -1) {
                if (!routes[routeIndex].equipment) {
                    routes[routeIndex].equipment = [];
                }
                routes[routeIndex].equipment.push(newEquipment);
                localStorage.setItem('ispRoutes', JSON.stringify(routes));
                
                // Atualizar a visualização
                currentRoute = routes[routeIndex];
                loadEquipment();
                loadEquipmentManager();
                
                event.target.reset();
                showNotification('Equipamento adicionado com sucesso!', 'success');
            }
        }

        // Editar equipamento
        function editEquipment(equipmentId) {
            const equipment = currentRoute.equipment.find(eq => eq.id == equipmentId);
            if (!equipment) return;

            const newName = prompt('Novo nome do equipamento:', equipment.name);
            if (newName && newName.trim() !== '') {
                const routes = JSON.parse(localStorage.getItem('ispRoutes')) || [];
                const routeIndex = routes.findIndex(r => r.id == currentRoute.id);
                
                if (routeIndex !== -1) {
                    const equipmentIndex = routes[routeIndex].equipment.findIndex(eq => eq.id == equipmentId);
                    if (equipmentIndex !== -1) {
                        routes[routeIndex].equipment[equipmentIndex].name = newName.trim();
                        localStorage.setItem('ispRoutes', JSON.stringify(routes));
                        
                        currentRoute = routes[routeIndex];
                        loadEquipment();
                        loadEquipmentManager();
                        showNotification('Equipamento atualizado!', 'success');
                    }
                }
            }
        }

        // Excluir equipamento
        function deleteEquipment(equipmentId) {
            if (!confirm('Tem certeza que deseja excluir este equipamento?')) return;
            
            const routes = JSON.parse(localStorage.getItem('ispRoutes')) || [];
            const routeIndex = routes.findIndex(r => r.id == currentRoute.id);
            
            if (routeIndex !== -1) {
                routes[routeIndex].equipment = routes[routeIndex].equipment.filter(eq => eq.id != equipmentId);
                localStorage.setItem('ispRoutes', JSON.stringify(routes));
                
                currentRoute = routes[routeIndex];
                loadEquipment();
                loadEquipmentManager();
                showNotification('Equipamento excluído!', 'success');
            }
        }

        // Funções auxiliares
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function getLinkType(routeType) {
            const types = {
                'fibra': 'Fibra Óptica',
                'radio': 'Rádio Enlace',
                'metro': 'Metro Ethernet'
            };
            return types[routeType] || routeType;
        }

        function getEquipmentTypeDisplay(type) {
            const types = {
                'olt': 'OLT',
                'onu': 'ONU/Cliente',
                'switch': 'Switch',
                'router': 'Roteador',
                'radio': 'Rádio',
                'dwdm': 'DWDM',
                'servidor': 'Servidor',
                'cto': 'CTO/Caixa',
                'director': 'Director Class',
                'outro': 'Outro'
            };
            return types[type] || type;
        }

        function getIconDisplayName(iconType) {
            const iconNames = {
                'default': 'Ponto Padrão',
                'nuvem': 'nuvem',
                'radio': 'Rádio',
                'torre': 'Torre',
                'router': 'Router',
                'switch': 'Switch',
                'dwdm': 'DWDM',
                'atencao': 'Atenção'
            };
            return iconNames[iconType] || iconType;
        }

        function getRedundancyTypeDisplay(type) {
            const types = {
                'primary': 'Primária',
                'secondary': 'Secundária', 
                'backup': 'Backup'
            };
            return types[type] || type;
        }

        function viewOnMap() {
            if (currentRoute) {
                localStorage.setItem('viewRouteId', currentRoute.id);
                window.location.href = 'index.html';
            }
        }

        function showNotification(message, type) {
            // Criar notificação simples
            alert(message);
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
            loadRoutes();
            
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Fechar modal ao clicar fora
            document.getElementById('equipmentModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEquipmentModal();
                }
            });

            // Filtros
            document.getElementById('routeTypeFilter').addEventListener('change', filterRoutes);
            document.getElementById('statusFilter').addEventListener('change', filterRoutes);
            document.getElementById('searchBox').addEventListener('input', filterRoutes);
        });

        // Filtrar rotas
        function filterRoutes() {
            const typeFilter = document.getElementById('routeTypeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();

            const routeItems = document.querySelectorAll('.route-item');
            
            routeItems.forEach(item => {
                const routeId = item.getAttribute('data-route-id');
                const route = allRoutes.find(r => r.id == routeId);
                if (!route) return;

                let show = true;

                // Filtro por tipo
                if (typeFilter !== 'all' && route.type !== typeFilter) {
                    show = false;
                }

                // Filtro por busca
                if (searchTerm && !route.name.toLowerCase().includes(searchTerm)) {
                    show = false;
                }

                item.style.display = show ? 'block' : 'none';
            });
        }
    </script>
</body>
</html>
